<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <link rel="stylesheet" href="switch.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body {
            background-color: #e1e1e8;
            z-index: -1;
            background-image: url("images/system/nemeck.jpg");
            background-repeat: repeat-x;
        }

        .item {
            position: relative;
            min-width: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            background-color: white;
        }

        .box {
            display: flex;
        }

        .column {
            width: 100%;
            padding: 5px;
        }

        .text-1 {
            padding: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
        }

        .column.left {
            min-width: 40%;
            width: auto;
            flex-basis: content;
        }

        .footer {
            display: flex;
            padding: 5px;
        }

        .header {
            display: flex;
            padding: 5px;
        }

        .footer::after {
            content: "";
            clear: both;
            display: table;
        }

        img {
            display: block;
            max-width: 100%;
            max-height: 308px;
        }

        .bottom-right {
            position: absolute;
            right: 15px;
            bottom: 15px;
        }

        .list-group-item.box {
            padding: 5px;
        }

        .switch-frame {
            border: 1px solid lightgrey;
            border-radius: 5px;
            padding: 5px;
            width: 240px;
            min-width: 240px;
            display: flex
        }

        .sale-text {
            margin-right: 5px;
            margin-top: 9px
        }

        .sold {
            color: red;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: 0 -50% 0 0;
            transform: translate(-50%, -50%);
            font-size: 108px;
            z-index: 1;
        }
        .modal-header, h4, .close {
            background-color: #5cb85c;
            color:white !important;
            text-align: center;
            font-size: 30px;
        }

        .sign-in {
            background-color: #2196F3;
        }

        .modal-footer {
            background-color: #f9f9f9;
        }

        .filters {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            min-width: 400px;
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; margin-bottom: 10px">
        <button class="btn btn-secondary" id="additem"
                style="margin-right: 10px; display: none">Добавить объявление</button>
        <button type="button" data-toggle="modal" data-target="#registry-modal" class="btn btn-success"
                style="margin-right: 10px; display: none"
                id="registry-btn">Зерегистрироваться</button>
        <button type="button" data-toggle="modal" data-target="#login-modal" class="btn btn-primary"
                style="margin-right: 10px; display: none"
                id="login-btn">Войти</button>
        <div id="greeting-div" style="flex-grow: 1; display: none; line-height: 0.7em; color: white">
            <h6 id="greeting" style="text-align: right;"></h6>
            <div style="text-align: right"><a id="exit" href="#">Выйти</a></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="login-modal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="login-content">
                <div class="modal-header sign-in" style="padding:35px 50px;">
                    <h4 class="modal-title sign-in" style="width: 100%">&#128274;Login</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 40px 50px">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i>Имя пользователя</label>
                        <input type="text" class="form-control" id="username" placeholder="Введите логин">
                        <div id="wrong-login" class="invalid-feedback" style="display: none">
                            Имя пользователя или пароль неверны.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password"><i class="fas fa-eye"></i>Пароль</label>
                        <input type="password" class="form-control" id="password" placeholder="Введите пароль">
                    </div>
                    <button type="button" id="btn-login" class="btn btn-primary btn-block"
                            onclick="loginUser()"><i class="fas fa-power-off"></i> Войти</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-default" data-dismiss="modal"><i class="fas fa-times"></i> Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registry Modal -->
    <div class="modal fade" id="registry-modal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="registry-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <h4 class="modal-title" style="width: 100%"><i class="fas fa-user-plus"></i> Registration</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 40px 50px">
                    <div class="form-group row">
                        <label for="username-reg" class="col-lg-3 col-form-label" style="min-width: 170px">Имя пользователя:</label>
                        <div class="col-lg-9" style="max-width: 100%">
                            <input type="text" class="form-control" id="username-reg" placeholder="Введите логин">
                            <div id="repeated-login" class="invalid-feedback" style="display: none">
                                Такой пользователь уже существует.
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="password-reg" class="col-lg-3 col-form-label" style="min-width: 170px">Пароль:</label>
                        <div class="col-lg-9">
                            <input type="password" class="form-control" id="password-reg" placeholder="Введите пароль">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="tel" class="col-lg-3 col-form-label" style="min-width: 170px">Телефон:</label>
                        <div class="col-lg-9">
                            <input type="tel" class="form-control" id="tel" name="phone"
                                   placeholder="+7 (999) 999-99-99"
                                   pattern="\+7 \([0-9]{3}\) [0-9]{3}-[0-9]{2}-[0-9]{2}">
                        </div>
                    </div>
                    <button type="button" id="btn-registry" class="btn btn-success btn-block"
                            onclick="registryUser()">Зарегистрироваться</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-default" data-dismiss="modal"><i class="fas fa-times"></i> Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="form-inline filters">
        <label for="filter" class="mr-sm-2 mt-2 ml-2">Показать:</label>
        <select class="form-control mb-2 mt-2 mr-sm-2" id="filter">
            <option value = 'ALL'>Все</option>
            <option value = 'TODAY'>Только за сегодня</option>
            <option value = 'WITH_IMG'>Только с картинкой</option>
            <option value = 'BRAND'>По бренду</option>
        </select>
        <label for="filteredBrand" class="mr-sm-2 mt-2" id="label-filteredBrand" style="display: none">Марка:</label>
        <select class="form-control mb-2 mr-sm-2 mt-2" id="filteredBrand" style="display: none">
            <option selected value='-1'>-</option>
        </select>
    </div>
    <div class="all-items">
    </div>
</div>
</body>

<script>
    var userId = -1;
    var filter = "ALL"; //"TODAY" //"WITH_IMG" //"BRAND"
    var filteredBrand = "";
    var ALL = "ALL";

    $(loadBrand());

    $(
      $("#filter").change(function () {
          var filterStatus = $(this).children(":selected").val();
          if (filterStatus !== 'BRAND') {
              $("#filteredBrand").hide();
              $("#label-filteredBrand").hide();
              filter = filterStatus;
              loadItems();
          } else {
              $("#filteredBrand").show();
              $("#label-filteredBrand").show();
              var brandId = $("#filteredBrand").children(":selected").val();
              if (brandId !== '-1') {
                  filter = filterStatus;
                  filteredBrand = brandId;
                  loadItems();
              } else {
                  filter = ALL;
                  loadItems();
              }
          }
      })
    );

    $(
       $("#filteredBrand").change(function () {
           var filterStatus = $("#filter").children(":selected").val();
           var brandId = $(this).children(":selected").val();
           if (filterStatus !== 'BRAND') {
               return;
           }
           if (brandId !== '-1') {
               filter = filterStatus;
               filteredBrand = brandId;
               loadItems();
           } else {
               filter = ALL;
               loadItems();
           }
       })
    );

    function loadBrand() {
        $.ajax("./car_parts", {
            type: "get",
            data: "type=brand",
            dataType: "json"
        }).done(function (values) {
            var result = "";
            result += "<option selected value='-1'>-</option>";
            values.forEach(function (value) {
                result += "<option value='" + value.id + "'>" + value.title + "</option>";
            });
            $("#filteredBrand").html(result);
        });
    }

    $(
        function() {
            $("#tel").mask("+7 (999) 999-99-99");
        }
    );

    $(
        $("#additem").click(function () {
            window.location.href = "additem.html";
        })
    );

    $(
        validateElements()
    );

    function resetElements(data) {
        if (data.username) {
            userId = data.userId;
            if (userId !== 0) {
                $("#additem").show();
            }
            $("#registry-btn").hide();
            $("#login-btn").hide();
            $("#greeting-div").show();
            $("#greeting").html("Текущий пользователь: " + data.username).show();
        } else {
            userId = -1;
            $("#additem").hide();
            $("#registry-btn").show();
            $("#login-btn").show();
            $("#greeting-div").hide();
        }
    }

    function validateElements() {
        return $.ajax("./session-state").done(function (data) {
            resetElements(data);
            updateFooter();
        })
    }

    function registryUser() {
        if (validateReg()) {
            var login = $("#username-reg").val();
            var password = $("#password-reg").val();
            var tel = $("#tel").val();
            $.ajax("./registry", {
                type: "post",
                data: {
                    login: login,
                    password: password,
                    tel: tel
                },
                dataType: "json"
            }).done(function (data) {
                var login = $("#username-reg");
                var password = $("#password-reg");
                var tel = $("#tel");
                if (data.repeatedLogin === "error") {
                    login.removeClass("is-valid").addClass("is-invalid");
                    $("#repeated-login").show();
                } else if (data.username) {
                    login.removeClass("is-invalid").removeClass("is-valid");
                    login.removeClass("is-invalid").removeClass("is-valid").val("");
                    password.removeClass("is-invalid").removeClass("is-valid").val("");
                    tel.removeClass("is-invalid").removeClass("is-valid").val("");
                    $("#repeated-login").hide();
                    resetElements(data);
                    updateFooter();
                    $("#registry-modal").modal("hide");
                }
            })
        }
    }

    function validateReg() {
        var result = true;
        var login = $("#username-reg");
        var password = $("#password-reg");
        var tel = $("#tel");
        if (login.val() === "") {
            login.removeClass("is-invalid").addClass("is-invalid");
            result = false;
        } else {
            login.removeClass("is-invalid").addClass("is-valid");
        }
        if (password.val() === "") {
            password.removeClass("is-invalid").addClass("is-invalid");
            result = false;
        } else {
            password.removeClass("is-invalid").addClass("is-valid");
        }
        if (tel.val() === "") {
            tel.removeClass("is-invalid").addClass("is-invalid");
            result = false;
        } else {
            tel.removeClass("is-invalid").addClass("is-valid");
        }
        return result;
    }

    function validateLogin() {
        var result = true;
        var login = $("#username");
        var password = $("#password");
        if (login.val() === "") {
            login.addClass("is-invalid");
            result = false;
        } else {
            login.removeClass("is-invalid");
        }
        if (password.val() === "") {
            password.addClass("is-invalid");
            result = false;
        } else {
            password.removeClass("is-invalid");
        }
        return result;
    }

    function loginUser() {
        if (validateLogin()) {
            var login = $("#username").val();
            var password = $("#password").val();
            $.ajax("./login", {
                type: "post",
                data: {
                    login: login,
                    password: password
                },
                dataType: "json"
            }).done(function (data) {
                if (data.username) {
                    $("#username").removeClass("is-invalid").removeClass("is-valid").val("");
                    $("#password").removeClass("is-invalid").removeClass("is-valid").val("");
                    $("#wrong-login").hide();
                    resetElements(data);
                    updateFooter();
                    $("#login-modal").modal("hide");
                }
            }).fail(function () {
                $("#username").removeClass("is-valid").addClass("is-invalid");
                $("#password").removeClass("is-valid").addClass("is-invalid");
                $("#wrong-login").show();
            })
        }
    }

    $(
        $("#exit").click(function (e) {
            e.preventDefault();
            logout();
        })
    );

    function logout() {
        $.post("./logout").done(function () {
            userId = -1;
            validateElements();
        });
        return false;
    }

    $(function() {
        loadItems();
        setInterval(function () {
            checkItems();
            updateStatus();
            validateElements();
        }, 5000);
    });

    function loadItems() {
        $.ajax("./items", {
            data: {
                filter: filter,
                filteredBrand: filteredBrand
            },
            dataType: "json"
        }).done(function (data) {
            var allItems = $(".all-items");
            allItems.empty();
            data.forEach(function (item) {
                var itemHtml = "<div class=\"item\">\n" +
                    "<input type='hidden' class='item_id'/>" +
                    "<input type='hidden' class='user_id'/>" +
                    "            <div class=\"sold\"></div>\n" +
                    "            <div class=\"header\">\n" +
                    "                <div style=\"width: 50%\"><h6 class='item_title'>Продаю ламбу новую</h6></div>\n" +
                    "                <div class='tel' style=\"width: 50%; text-align: right\"></div>\n" +
                    "            </div>\n" +
                    "            <div class=\"box\">\n" +
                    "                <div class=\"column left\">\n" +
                    "                    <img alt=\"car\"/>\n" +
                    "                </div>\n" +
                    "                <div class=\"column\">\n" +
                    "                    <ul class=\"list-group\">\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Марка:</div>\n" +
                    "                            <div class=\"column text-1 brand\"></div>\n" +
                    "                        </li>\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Модель:</div>\n" +
                    "                            <div class=\"column text-1 model\"></div>\n" +
                    "                        </li>\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Тип кузова:</div>\n" +
                    "                            <div class=\"column text-1 body\"></div>\n" +
                    "                        </li>\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Тип двигателя:</div>\n" +
                    "                            <div class=\"column text-1 engine\"></div>\n" +
                    "                        </li>\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Привод:</div>\n" +
                    "                            <div class=\"column text-1 drive\"></div>\n" +
                    "                        </li>\n" +
                    "                        <li class=\"list-group-item box\">\n" +
                    "                            <div class=\"column text-1\">Коробка передач:</div>\n" +
                    "                            <div class=\"column text-1 trans\"></div>\n" +
                    "                        </li>\n" +
                    "                    </ul>\n" +
                    "                </div>\n" +
                    "            </div>\n" +
                    "            <div class=\"footer\">\n" +
                    "                <div class=\"switch-frame\">\n" +
                    "                    <div class=\"sale-text\">Объявление продано</div>\n" +
                    "                    <label class=\"switch\">\n" +
                    "                        <input type=\"checkbox\" class=\"danger\">\n" +
                    "                        <span class=\"slider round\"></span>\n" +
                    "                    </label>\n" +
                    "                </div>\n" +
                    "                <div style=\"width: 100%\">\n" +
                    "                    <button type=\"button\" class=\"btn btn-outline-danger bottom-right delete\">&times; Delete</button>\n" +
                    "                </div>\n" +
                    "            </div>\n" +
                    "        </div>";
                let newElements = $(itemHtml).appendTo(allItems);
                newElements.find(".item_title").text(item.title);
                newElements.find(".tel").text(item.user.tel);
                if (item.picture != null) {
                    newElements.find("img").prop("src", "images/" + item.picture);
                } else {
                    newElements.find("img").prop("src", "images/system/No_image.png");
                }
                newElements.find(".brand").text(item.brand.title);
                newElements.find(".model").text(item.model.title);
                newElements.find(".body").text(item.body.title);
                newElements.find(".engine").text(item.engine.title);
                newElements.find(".drive").text(item.drive.title);
                newElements.find(".trans").text(item.trans.title);
                newElements.find(".item_id").val(item.id);
                newElements.find(".user_id").val(item.user.id);
                newElements.find(".danger").prop("checked", item.sold);
                if (item.sold === true) {
                    newElements.find(".sold").text("SOLD");
                } else {
                    newElements.find(".sold").text("");
                }
                if (userId === 0 || item.user.id === userId) {
                    newElements.find(".footer").show();
                } else {
                    newElements.find(".footer").hide();
                }
            });
        })
    }

    function updateFooter() {
        var items = $(".all-items").children();
        items.each(function () {
            let id = +$(this).find(".user_id").val();
            if (userId === 0 || id === userId) {
                $(this).find(".footer").show();
            } else {
                $(this).find(".footer").hide();
            }
        })
    }

    var allItems = $(".all-items");

    allItems.on("click", ".delete", function () {
        swal({
            title: "Уверены?",
            text: "Восстановить объявление будет невозможно.",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    var item = $(this).closest(".item");
                    var itemId = item.find(".item_id").val();
                    var uId = item.find(".user_id").val();
                    $.ajax("./items", {
                        type: "post",
                        data: {
                            itemId: itemId,
                            userId: uId
                        },
                        dataType: "json"
                    }).done(function (data) {
                        if (data.success === true) {
                            item.remove();
                            swal("Poof! Your imaginary file has been deleted!", {
                                icon: "success",
                            });
                        }
                    });
                }
            });
    });

    function checkItems() {
        var itemId = $(".item:first").find(".item_id").val();
        var size = $(".item").length;
        return $.ajax("./check-items", {
            data: {
                lastId: itemId,
                size: size,
                filter: filter,
                filteredBrand: filteredBrand
            },
            dataType: "json"
        }).done(function (data) {
            if (data.needUpdate === true) {
                loadItems();
            }
        })
    }

    function updateStatus() {
        var items = $(".item");
        items.each(function () {
            var soldObj = $(this);
            var itemId = $(this).find(".item_id").val();
            var sold = $(this).find(".danger").prop("checked");
            $.ajax("./check-status", {
                data: {
                    itemId: itemId,
                    sold: sold
                },
                dataType: "json"
            }).done(function (data) {
                if (data.change) {
                    if (data.sold === true) {
                        soldObj.find(".sold").text("SOLD");
                    } else {
                        soldObj.find(".sold").text("");
                    }
                    soldObj.find(".danger").prop("checked", data.sold);
                }
            })
        })
    }

    allItems.on("change", ".danger", function () {
        var item = $(this).closest(".item");
        var itemId = item.find(".item_id").val();
        var uId = item.find(".user_id").val();
        var sold = $(this).prop("checked");
        var curCheck = !item.find(".danger").prop("checked");
        if (confirm("сменить статус?")) {
            $.ajax("./update", {
                type: "post",
                data: {
                    itemId: itemId,
                    userId: uId,
                    sold: sold
                },
                dataType: "json"
            }).done(function (data) {
                if (data.success === true) {
                    if (data.sold === true) {
                        item.find(".sold").text("SOLD");
                        item.find(".danger").prop("checked", true);
                    } else {
                        item.find(".sold").text("");
                        item.find(".danger").prop("checked", false);
                    }
                }
            })
        } else {
            item.find(".danger").prop("checked", curCheck);
        }
    });

    $(
        $("#username, #password").keyup(function (event) {
            if (event.keyCode == 13) {
                $("#btn-login").click();
            }
        })
    );

    $(
        $("#username-reg, #password-reg, #tel").keyup(function (event) {
            if (event.keyCode == 13) {
                $("#btn-registry").click();
            }
        })
    );

    $(
        $("#login-modal").on("shown.bs.modal", function () {
            $("#username").focus();
        })
    );

    $(
        $("#registry-modal").on("shown.bs.modal", function () {
            $("#username-reg").focus();
        })
    );
</script>
</html>